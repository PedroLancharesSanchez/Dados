<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Juego de Dados</title>
  <style>
    /* Escala general del 80% */
    html {
      font-size: 80%;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background: white;
      overflow-x: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      min-height: 100vh;
      box-sizing: border-box;
      padding: 20px;
    }

    h1 {
      margin-bottom: 40px;
      font-size: 6em;
      text-align: center;
      line-height: 1.1;
    }

    .player-select,
    .controls {
      display: flex;
      flex-direction: column;
      gap: 40px;
      align-items: center;
      justify-content: center;
      margin-bottom: 60px;
      z-index: 20;
    }

    button {
      padding: 40px 80px;
      font-size: 4.4em;
      cursor: pointer;
      border-radius: 20px;
      border: 2px solid #333;
      background-color: white;
      transition: background 0.2s ease;
      min-width: 280px;
    }

    button:hover {
      background: #ddd;
    }

    .score {
      position: fixed;
      background: white;
      padding: 20px 40px;
      border: 2px solid black;
      border-radius: 20px;
      min-width: 280px;
      text-align: center;
      font-weight: bold;
      font-size: 4em;
      box-sizing: border-box;
      z-index: 100;
      user-select: none;
    }

    /* Posiciones fijas en esquinas */
    .p1 { top: 0; left: 0; border-top-left-radius: 0; }
    .p2 { top: 0; right: 0; border-top-right-radius: 0; }
    .p3 { bottom: 0; left: 0; border-bottom-left-radius: 0; }
    .p4 { bottom: 0; right: 0; border-bottom-right-radius: 0; }

    /* Dados en 2 filas, 3 columnas */
    .dice-container {
      width: 560px;
      display: grid;
      grid-template-columns: repeat(3, 160px);
      grid-template-rows: repeat(2, 160px);
      gap: 30px 20px;
      justify-content: center;
      margin: 40px 0;
      position: relative;
      z-index: 15;
    }

    .dice {
      width: 160px;
      height: 160px;
      object-fit: contain;
      border-radius: 20px;
      position: relative; /* ya no absoluto para grid */
      transition: box-shadow 0.3s ease;
      user-select: none;
      overflow: visible;
    }

    #turno-actual {
      font-weight: bold;
      font-size: 5em;
      margin-bottom: 20px;
      z-index: 20;
      text-align: center;
      width: 100%;
      user-select: none;
    }

    #puntos-turno {
      margin-top: 30px;
      font-style: italic;
      font-size: 4em;
      text-align: center;
      z-index: 20;
      width: 100%;
      user-select: none;
    }

    #resultados-tiradas {
      margin-top: 40px;
      display: flex;
      gap: 30px;
      min-height: 200px;
      width: 560px;
      flex-wrap: wrap;
      justify-content: center;
      border: 2px solid #333;
      padding: 20px;
      border-radius: 20px;
      background: #fafafa;
      position: relative;
      z-index: 10;
      box-sizing: border-box;
      user-select: none;
    }

    .dice-result {
      width: 120px !important;
      height: 120px !important;
      position: relative !important;
      box-shadow: 0 0 20px 8px green;
      border-radius: 20px;
      margin: 0 10px;
      transition: box-shadow 0.3s ease;
      user-select: none;
    }

    .color1 { box-shadow: 0 0 30px 8px #4CAF50 !important; }
    .color2 { box-shadow: 0 0 30px 8px #2196F3 !important; }
    .color3 { box-shadow: 0 0 30px 8px #FF9800 !important; }
    .color4 { box-shadow: 0 0 30px 8px #9C27B0 !important; }
    .color5 { box-shadow: 0 0 30px 8px #E91E63 !important; }
    .color6 { box-shadow: 0 0 30px 8px #00BCD4 !important; }

    .resaltado-actual {
      box-shadow: 0 0 30px 8px #4CAF50 !important;
    }

    .resaltado-previo {
      box-shadow: 0 0 30px 8px #2196F3 !important;
    }

    /* Video ajustado para dado - tama√±o 20% mayor que caja */
    video {
      position: absolute;
      top: -16px;
      left: -16px;
      width: 192px; /* 160 * 1.2 */
      height: 192px;
      z-index: 10;
      clip-path: none;
      user-select: none;
      pointer-events: none;
      border-radius: 20px;
    }

    /* Responsive m√≥vil */
    @media (max-width: 768px) {
      html {
        font-size: 60%;
      }

      body {
        padding: 10px;
      }

      h1 {
        font-size: 3em;
        margin-bottom: 20px;
      }

      .player-select,
      .controls {
        gap: 20px;
        margin-bottom: 30px;
      }

      button {
        padding: 20px 40px;
        font-size: 2.2em;
        min-width: 160px;
      }

      .score {
        font-size: 2.5em;
        padding: 10px 20px;
        min-width: 150px;
      }

      .dice-container {
        width: 100%;
        grid-template-columns: repeat(3, 80px);
        grid-template-rows: repeat(2, 80px);
        gap: 15px 10px;
        margin: 20px 0;
      }

      .dice {
        width: 80px !important;
        height: 80px !important;
        position: relative !important;
        top: auto !important;
        left: auto !important;
      }

      #resultados-tiradas {
        width: 100%;
        min-height: 120px;
        margin-top: 20px;
        padding: 10px;
      }

      .dice-result {
        width: 60px !important;
        height: 60px !important;
        margin: 0 5px;
      }

      #turno-actual {
        font-size: 3em;
        margin-bottom: 10px;
      }

      #puntos-turno {
        font-size: 2.5em;
        margin-top: 10px;
      }

      .score.p1 { top: 0; left: 0; }
      .score.p2 { top: 0; right: 0; }
      .score.p3 { bottom: 0; left: 0; }
      .score.p4 { bottom: 0; right: 0; }

      video {
        top: -8px;
        left: -8px;
        width: 96px;
        height: 96px;
      }
    }
  </style>
</head>
<body>

  <h1>Selecciona n√∫mero de jugadores</h1>
  <div class="player-select">
    <button onclick="selectPlayers(2)">2 Jugadores</button>
    <button onclick="selectPlayers(3)">3 Jugadores</button>
    <button onclick="selectPlayers(4)">4 Jugadores</button>
  </div>

  <div id="turno-actual"></div>

  <div class="dice-container" id="dados"></div>

  <div class="controls" style="display:none;">
    <button onclick="lanzarDados()">üé≤ Lanzar Dados</button>
    <button onclick="plantarse()">‚úã Plantarse</button>
  </div>

  <div id="puntos-turno"></div>

  <div id="resultados-tiradas"></div>

<script>
  let jugadores = 0;
  let puntuaciones = [];
  let turno = 0;
  let puntosTurno = 0;
  let dadosRestantes = 6;

  let tiradaNumero = -1;
  const coloresTiradas = ["color1","color2","color3","color4","color5","color6"];

  let dadosResaltadosPrevios = [];

  // Duraci√≥n fija del video en ms (ej: 1500ms)
  const DURACION_VIDEO = 1500;

  let puntosUltimaTirada = 0;

  function selectPlayers(count) {
    jugadores = count;
    puntuaciones = Array(count).fill(0);

    document.querySelector("h1").style.display = "none";
    document.querySelector(".player-select").style.display = "none";

    const posiciones = ["p1", "p2", "p3", "p4"];
    for(let i = 0; i < 4; i++) {
      const old = document.getElementById(`jugador${i}`);
      if(old) old.remove();
    }
    for (let i = 0; i < count; i++) {
      const marcador = document.createElement("div");
      marcador.className = `score ${posiciones[i]}`;
      marcador.id = `jugador${i}`;
      marcador.textContent = `Jugador ${i + 1}: 0`;
      document.body.appendChild(marcador);
    }

    document.querySelector(".controls").style.display = "flex";
    mostrarTurno();
  }

  function mostrarTurno() {
    document.getElementById("turno-actual").textContent = `Turno de Jugador ${turno + 1}`;
  }

  function mostrarDados(valores) {
    const contenedor = document.getElementById("dados");
    contenedor.innerHTML = "";

    valores.forEach((valor, idx) => {
      const dadoWrapper = document.createElement("div");
      dadoWrapper.style.position = "relative";
      dadoWrapper.style.width = "160px";
      dadoWrapper.style.height = "160px";

      const img = document.createElement("img");
      img.src = `img/dice${valor}.png`;
      img.alt = `Dado ${valor}`;
      img.className = "dice";

      dadoWrapper.appendChild(img);
      contenedor.appendChild(dadoWrapper);
    });
  }

  function animarDado(dadoWrapper, callback) {
    const video = document.createElement("video");
    video.src = "video/lanzar.mp4";
    video.autoplay = true;
    video.loop = false;
    video.muted = true;
    video.playsInline = true;
    video.style.position = "absolute";
    video.style.top = "-16px";
    video.style.left = "-16px";
    video.style.width = "192px"; // 160 * 1.2
    video.style.height = "192px";
    video.style.borderRadius = "20px";
    dadoWrapper.appendChild(video);

    // Eliminamos el video tras DURACION_VIDEO ms forzado
    const timeoutId = setTimeout(() => {
      video.remove();
      if (callback) callback();
    }, DURACION_VIDEO);

    video.onended = () => {
      clearTimeout(timeoutId);
      video.remove();
      if (callback) callback();
    };
  }

  function lanzarDados() {
    if (dadosRestantes <= 0) {
      // En vez de bloquear, asignamos 6 dados si es 0.
      dadosRestantes = 6;
    }
  
    const cantidad = dadosRestantes;
    const dados = Array.from({ length: cantidad }, () => Math.floor(Math.random() * 6) + 1);
  
    mostrarDados(dados);
  
    const contenedor = document.getElementById("dados");
    let animacionesPendientes = cantidad;
  
    for (let i = 0; i < cantidad; i++) {
      const dadoWrapper = contenedor.children[i];
      animarDado(dadoWrapper, () => {
        animacionesPendientes--;
        if (animacionesPendientes === 0) {
          setTimeout(() => {
            procesarTirada(dados);
          }, 1000);
        }
      });
    }
  }

  // Funci√≥n que calcula puntos, dados √∫tiles e √≠ndices de dados puntuados
  function calcularPuntosConIndices(dados) {
    const contador = {};
    dados.forEach(d => contador[d] = (contador[d] || 0) + 1);

    let puntos = 0;
    let dadosUtiles = 0;
    let indicesUtiles = [];

    // Ejemplo simple: 1's y 5's suman puntos
    if (contador[1] > 0) {
      puntos += contador[1] * 100;
      dadosUtiles += contador[1];
      let encontrados = 0;
      for(let j = 0; j < dados.length && encontrados < contador[1]; j++) {
        if(dados[j] === 1 && !indicesUtiles.includes(j)) {
          indicesUtiles.push(j);
          encontrados++;
        }
      }
    }
    if (contador[5] > 0) {
      puntos += contador[5] * 50;
      dadosUtiles += contador[5];
      let encontrados = 0;
      for(let j = 0; j < dados.length && encontrados < contador[5]; j++) {
        if(dados[j] === 5 && !indicesUtiles.includes(j)) {
          indicesUtiles.push(j);
          encontrados++;
        }
      }
    }

    return { puntos, dadosUtiles, indicesUtiles };
  }

  function procesarTirada(dados) {
    const { puntos, dadosUtiles, indicesUtiles } = calcularPuntosConIndices(dados);
  
    if (puntos === 0) {
      alert("¬°No has puntuado en esta tirada! Pierdes el turno.");
      resetTurno();
      pasarTurno();
      return;
    }
  
    puntosTurno += puntos;
    dadosRestantes -= dadosUtiles;
  
    // Si quedan 0 dados para tirar, reiniciar dadosRestantes a 6
    if (dadosRestantes === 0) {
      dadosRestantes = 6;
    }
  
    puntosUltimaTirada = puntos;
    actualizarPuntosTurno();
    moverDadosPuntuados(indicesUtiles);
  }
  // Actualiza el texto con puntos de tirada y total acumulado en el turno
  function actualizarPuntosTurno() {
    const elem = document.getElementById("puntos-turno");
    elem.textContent = `Puntos esta tirada: ${puntosUltimaTirada} | Total turno: ${puntosTurno} | Dados restantes: ${dadosRestantes}`;
  }

  // Clona s√≥lo dados que puntuaron para mostrar en resultados
  function moverDadosPuntuados(indicesUtiles) {
    const resultados = document.getElementById("resultados-tiradas");

    dadosResaltadosPrevios.forEach(clone => clone.remove());
    dadosResaltadosPrevios = [];

    tiradaNumero++;
    const colorActual = coloresTiradas[tiradaNumero % coloresTiradas.length];

    const contenedorDados = document.getElementById("dados");

    indicesUtiles.forEach(i => {
      const dadoOriginal = contenedorDados.children[i].querySelector("img");
      if(!dadoOriginal) return;

      const clone = dadoOriginal.cloneNode(true);
      clone.className = `dice-result ${colorActual}`;
      resultados.appendChild(clone);
      dadosResaltadosPrevios.push(clone);
    });
  }

  function plantarse() {
    puntuaciones[turno] += puntosTurno;
    document.getElementById(`jugador${turno}`).textContent = `Jugador ${turno + 1}: ${puntuaciones[turno]}`;
    resetTurno();
    pasarTurno();
  }

  function resetTurno() {
    puntosTurno = 0;
    puntosUltimaTirada = 0;
    dadosRestantes = 6;

    document.getElementById("puntos-turno").textContent = "";
    document.getElementById("dados").innerHTML = "";
    document.getElementById("resultados-tiradas").innerHTML = "";

    dadosResaltadosPrevios = [];
  }

  function pasarTurno() {
    turno = (turno + 1) % jugadores;
    mostrarTurno();
  }
</script>

</body>
</html>
