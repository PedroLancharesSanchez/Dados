<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Juego de Dados</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background: white;
      overflow-x: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      min-height: 100vh;
      box-sizing: border-box;
      padding: 20px;
    }

    h1 {
      margin-bottom: 40px;
      font-size: 6em;
      text-align: center;
      line-height: 1.1;
    }

    .player-select,
    .controls {
      display: flex;
      flex-direction: column;
      gap: 40px;
      align-items: center;
      justify-content: center;
      margin-bottom: 60px;
      z-index: 20;
    }

    button {
      padding: 40px 80px;
      font-size: 4.4em;
      cursor: pointer;
      border-radius: 20px;
      border: 2px solid #333;
      background-color: white;
      transition: background 0.2s ease;
      min-width: 280px;
    }

    button:hover {
      background: #ddd;
    }

    .score {
      position: fixed;
      background: white;
      padding: 20px 40px;
      border: 2px solid black;
      border-radius: 20px;
      min-width: 280px;
      text-align: center;
      font-weight: bold;
      font-size: 4em;
      box-sizing: border-box;
      z-index: 100;
      user-select: none;
    }

    /* Posiciones fijas en esquinas */
    .p1 { top: 0; left: 0; border-top-left-radius: 0; }
    .p2 { top: 0; right: 0; border-top-right-radius: 0; }
    .p3 { bottom: 0; left: 0; border-bottom-left-radius: 0; }
    .p4 { bottom: 0; right: 0; border-bottom-right-radius: 0; }

    .dice-container {
      display: flex;
      flex-wrap: nowrap;
      gap: 30px;
      justify-content: center;
      margin: 40px 0;
      position: relative;
      height: 200px;
      width: 1200px;
      z-index: 15;
    }

    .dice {
      width: 160px;
      height: 160px;
      object-fit: contain;
      border-radius: 20px;
      position: absolute;
      top: 0;
      left: 0;
      transition: box-shadow 0.3s ease;
      user-select: none;
    }

    #turno-actual {
      font-weight: bold;
      font-size: 5em;
      margin-bottom: 20px;
      z-index: 20;
      text-align: center;
      width: 100%;
      user-select: none;
    }

    #puntos-turno {
      margin-top: 30px;
      font-style: italic;
      font-size: 4em;
      text-align: center;
      z-index: 20;
      width: 100%;
      user-select: none;
    }

    #resultados-tiradas {
      margin-top: 40px;
      display: flex;
      gap: 30px;
      min-height: 200px;
      width: 1200px;
      flex-wrap: wrap;
      justify-content: center;
      border: 2px solid #333;
      padding: 20px;
      border-radius: 20px;
      background: #fafafa;
      position: relative;
      z-index: 10;
      box-sizing: border-box;
      user-select: none;
    }

    .dice-result {
      width: 120px !important;
      height: 120px !important;
      position: relative !important;
      top: auto !important;
      left: auto !important;
      box-shadow: 0 0 20px 8px green;
      border-radius: 20px;
      margin: 0 10px;
      transition: box-shadow 0.3s ease;
      user-select: none;
    }

    .color1 { box-shadow: 0 0 30px 8px #4CAF50 !important; }
    .color2 { box-shadow: 0 0 30px 8px #2196F3 !important; }
    .color3 { box-shadow: 0 0 30px 8px #FF9800 !important; }
    .color4 { box-shadow: 0 0 30px 8px #9C27B0 !important; }
    .color5 { box-shadow: 0 0 30px 8px #E91E63 !important; }
    .color6 { box-shadow: 0 0 30px 8px #00BCD4 !important; }

    .resaltado-actual {
      box-shadow: 0 0 30px 8px #4CAF50 !important;
    }

    .resaltado-previo {
      box-shadow: 0 0 30px 8px #2196F3 !important;
    }

    /* Video ajustado para el dado */
    video {
      position: absolute;
      top: 0;
      left: 0;
      width: 160px;
      height: 160px;
      z-index: 10;
      clip-path: none;
      user-select: none;
    }

    /* Responsive mÃ³vil */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      h1 {
        font-size: 3em;
        margin-bottom: 20px;
      }

      .player-select,
      .controls {
        gap: 20px;
        margin-bottom: 30px;
      }

      button {
        padding: 20px 40px;
        font-size: 2.2em;
        min-width: 160px;
      }

      .score {
        font-size: 2.5em;
        padding: 10px 20px;
        min-width: 150px;
      }

      .dice-container {
        position: relative;
        width: 100%;
        height: auto;
        gap: 15px;
        margin: 20px 0;
        flex-wrap: wrap;
        justify-content: center;
        height: auto;
      }

      .dice {
        position: relative !important;
        width: 80px !important;
        height: 80px !important;
        top: auto !important;
        left: auto !important;
      }

      #resultados-tiradas {
        width: 100%;
        min-height: 120px;
        margin-top: 20px;
        padding: 10px;
      }

      .dice-result {
        width: 60px !important;
        height: 60px !important;
        margin: 0 5px;
      }

      #turno-actual {
        font-size: 3em;
        margin-bottom: 10px;
      }

      #puntos-turno {
        font-size: 2.5em;
        margin-top: 10px;
      }

      .score.p1 { top: 0; left: 0; }
      .score.p2 { top: 0; right: 0; }
      .score.p3 { bottom: 0; left: 0; }
      .score.p4 { bottom: 0; right: 0; }
    }
  </style>
</head>
<body>

  <h1>Selecciona nÃºmero de jugadores</h1>
  <div class="player-select">
    <button onclick="selectPlayers(2)">2 Jugadores</button>
    <button onclick="selectPlayers(3)">3 Jugadores</button>
    <button onclick="selectPlayers(4)">4 Jugadores</button>
  </div>

  <div id="turno-actual"></div>

  <div class="dice-container" id="dados"></div>

  <div class="controls" style="display:none;">
    <button onclick="lanzarDados()">ðŸŽ² Lanzar Dados</button>
    <button onclick="plantarse()">âœ‹ Plantarse</button>
  </div>

  <div id="puntos-turno"></div>

  <div id="resultados-tiradas"></div>

<script>
  let jugadores = 0;
  let puntuaciones = [];
  let turno = 0;
  let puntosTurno = 0;
  let dadosRestantes = 6;

  let tiradaNumero = -1;
  const coloresTiradas = ["color1","color2","color3","color4","color5","color6"];

  let dadosResaltadosPrevios = [];

  function selectPlayers(count) {
    jugadores = count;
    puntuaciones = Array(count).fill(0);

    document.querySelector("h1").style.display = "none";
    document.querySelector(".player-select").style.display = "none";

    const posiciones = ["p1", "p2", "p3", "p4"];
    // Remover marcadores antiguos si existen
    for(let i = 0; i < 4; i++) {
      const old = document.getElementById(`jugador${i}`);
      if(old) old.remove();
    }
    for (let i = 0; i < count; i++) {
      const marcador = document.createElement("div");
      marcador.className = `score ${posiciones[i]}`;
      marcador.id = `jugador${i}`;
      marcador.textContent = `Jugador ${i + 1}: 0`;
      document.body.appendChild(marcador);
    }

    document.querySelector(".controls").style.display = "flex";
    mostrarTurno();
  }

  function mostrarTurno() {
    document.getElementById("turno-actual").textContent = `Turno de Jugador ${turno + 1}`;
  }

  function mostrarDados(valores) {
    const contenedor = document.getElementById("dados");
    contenedor.innerHTML = "";

    valores.forEach((valor, idx) => {
      const dadoWrapper = document.createElement("div");
      dadoWrapper.style.position = "relative";
      dadoWrapper.style.width = "160px";
      dadoWrapper.style.height = "160px";

      // En mÃ³vil posiciÃ³n relativa, en escritorio absoluta para que no se superpongan
      if(window.innerWidth > 768) {
        dadoWrapper.style.position = "absolute";
        dadoWrapper.style.left = `${idx * 180}px`;
        dadoWrapper.style.top = `0`;
      }

      const img = document.createElement("img");
      img.src = `img/dice${valor}.png`;
      img.alt = `Dado ${valor}`;
      img.className = "dice";

      dadoWrapper.appendChild(img);
      contenedor.appendChild(dadoWrapper);
    });
  }

  function animarDado(dadoWrapper, callback) {
    const video = document.createElement("video");
    video.src = "video/lanzar.mp4";
    video.muted = true;
    video.style.position = "absolute";
    video.style.top = "0";
    video.style.left = "0";
    video.style.width = dadoWrapper.clientWidth + "px";
    video.style.height = dadoWrapper.clientHeight + "px";
    video.style.zIndex = "10";
    video.style.clipPath = "none";

    dadoWrapper.appendChild(video);

    const sonido = new Audio("sounds/lanzar-dados.mp3");

    sonido.addEventListener("loadedmetadata", () => {
      if (video.readyState >= 2) {
        ajustarDuracion();
      } else {
        video.addEventListener("loadedmetadata", ajustarDuracion);
      }

      function ajustarDuracion() {
        const nuevaDuracion = sonido.duration - 2.3;
        video.playbackRate = video.duration / nuevaDuracion;
        video.play().catch(() => {});
        sonido.play().catch(() => {});
      }
    });

    video.onended = () => {
      dadoWrapper.removeChild(video);
      if (typeof callback === "function") callback();
    };
  }

  function lanzarDados() {
    if (dadosRestantes <= 0) {
      alert("No quedan dados para lanzar. Plantate o reinicia el turno.");
      return;
    }
    const cantidad = dadosRestantes;
    const dados = Array.from({ length: cantidad }, () => Math.floor(Math.random() * 6) + 1);

    const contenedor = document.getElementById("dados");
    contenedor.style.display = "block";
    mostrarDados(dados);

    let animacionesPendientes = cantidad;

    for (let i = 0; i < cantidad; i++) {
      const dadoWrapper = contenedor.children[i];
      animarDado(dadoWrapper, () => {
        animacionesPendientes--;
        if (animacionesPendientes === 0) {
          setTimeout(() => {
            procesarPuntos(dados);
            moverDadosPuntuados(dados);
          }, 1000);
        }
      });
    }
  }

  // FunciÃ³n mejorada: calcula puntos y ademÃ¡s devuelve Ã­ndices dados puntuados
  function calcularPuntosConIndices(dados) {
    let contador = [0,0,0,0,0,0,0];
    dados.forEach(d => contador[d]++);
    let puntos = 0;
    let dadosUtiles = 0;
    let indicesUtiles = [];

    // Escalera 1-6
    if (contador.slice(1).every(c => c === 1)) {
      puntos += 1500;
      dadosUtiles = 6;
      indicesUtiles = [0,1,2,3,4,5];
      return { puntos, dadosUtiles, indicesUtiles };
    }

    // Tripletas y mÃ¡s
    for (let i = 1; i <= 6; i++) {
      if (contador[i] >= 3) {
        if (i === 1) {
          puntos += (contador[i] === 3) ? 1000 : 1000 * 2**(contador[i]-3);
        } else {
          puntos += i * 100 * 2**(contador[i]-3);
        }
        dadosUtiles += contador[i];

        // Encontrar Ã­ndices dados puntuados de ese valor i
        let encontrados = 0;
        for(let j = 0; j < dados.length && encontrados < contador[i]; j++) {
          if(dados[j] === i) {
            indicesUtiles.push(j);
            encontrados++;
          }
        }
        contador[i] = 0;
      }
    }

    // 1's y 5's sueltos
    if (contador[1] > 0) {
      puntos += contador[1] * 100;
      dadosUtiles += contador[1];
      let encontrados = 0;
      for(let j = 0; j < dados.length && encontrados < contador[1]; j++) {
        if(dados[j] === 1 && !indicesUtiles.includes(j)) {
          indicesUtiles.push(j);
          encontrados++;
        }
      }
    }
    if (contador[5] > 0) {
      puntos += contador[5] * 50;
      dadosUtiles += contador[5];
      let encontrados = 0;
      for(let j = 0; j < dados.length && encontrados < contador[5]; j++) {
        if(dados[j] === 5 && !indicesUtiles.includes(j)) {
          indicesUtiles.push(j);
          encontrados++;
        }
      }
    }

    return { puntos, dadosUtiles, indicesUtiles };
  }

  // ModificaciÃ³n: procesa puntos y actualiza texto
  function procesarPuntos(dados) {
    const { puntos, dadosUtiles } = calcularPuntosConIndices(dados);
    puntosTurno += puntos;
    dadosRestantes -= dadosUtiles;

    document.getElementById("puntos-turno").textContent = `Puntos esta tirada: ${puntos} | Dados restantes: ${dadosRestantes}`;
  }

  // CorrecciÃ³n: sÃ³lo clona dados que puntuaron en esta tirada y limpia resultados anteriores
  function moverDadosPuntuados(dados) {
    const resultados = document.getElementById("resultados-tiradas");

    // Limpia dados resaltados previos
    dadosResaltadosPrevios.forEach(clone => clone.remove());
    dadosResaltadosPrevios = [];

    tiradaNumero++;
    const colorActual = coloresTiradas[tiradaNumero % coloresTiradas.length];

    const { indicesUtiles } = calcularPuntosConIndices(dados);

    if(indicesUtiles.length === 0) {
      // Si no puntuaron dados, no agregar nada
      return;
    }

    const contenedorDados = document.getElementById("dados");

    indicesUtiles.forEach(i => {
      const dadoOriginal = contenedorDados.children[i].querySelector("img");
      if(!dadoOriginal) return;

      // Clonamos el dado para ponerlo en resultados
      const clone = dadoOriginal.cloneNode(true);
      clone.className = `dice-result ${colorActual}`;
      resultados.appendChild(clone);
      dadosResaltadosPrevios.push(clone);
    });
  }

  function plantarse() {
    puntuaciones[turno] += puntosTurno;
    document.getElementById(`jugador${turno}`).textContent = `Jugador ${turno + 1}: ${puntuaciones[turno]}`;
    puntosTurno = 0;
    dadosRestantes = 6;

    // Limpiar texto y dados y resultados al cambiar turno
    document.getElementById("puntos-turno").textContent = "";
    document.getElementById("dados").innerHTML = "";
    document.getElementById("resultados-tiradas").innerHTML = "";

    dadosResaltadosPrevios = [];

    pasarTurno();
  }

  function pasarTurno() {
    turno = (turno + 1) % jugadores;
    mostrarTurno();
  }
</script>

</body>
</html>
