<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Juego de Dados</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      background: white;
      padding-top: 20px;
      position: relative;
      overflow-x: hidden;
    }

    h1 {
      margin-bottom: 20px;
      font-size: 3em;
      text-align: center;
    }

    .player-select,
    .controls {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
      justify-content: center;
      margin-bottom: 30px;
      position: relative;
      z-index: 20;
    }

    button {
      padding: 20px 40px;
      font-size: 2.2em;
      cursor: pointer;
      border-radius: 10px;
      border: 2px solid #333;
      background-color: white;
      transition: background 0.2s ease;
    }

    button:hover {
      background: #ddd;
    }

    .score {
      position: absolute;
      background: white;
      padding: 10px 20px;
      border: 2px solid black;
      border-radius: 10px;
      min-width: 140px;
      text-align: center;
      font-weight: bold;
      font-size: 2em;
      z-index: 10;
    }

    .p1 { top: 10px; left: 10px; }
    .p2 { top: 10px; right: 10px; }
    .p3 { bottom: 10px; left: 10px; }
    .p4 { bottom: 10px; right: 10px; }

    .dice-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin: 20px 0;
      position: relative;
      height: 100px; /* suficiente para posicion absoluta de dados */
      width: 600px;
      z-index: 15;
    }

    .dice {
      width: 80px;
      height: 80px;
      object-fit: contain;
      border-radius: 10px;
      position: absolute;
      top: 0;
      left: 0;
      transition: box-shadow 0.3s ease;
    }

    #turno-actual {
      font-weight: bold;
      font-size: 2.5em;
      margin-bottom: 10px;
      z-index: 20;
    }

    #puntos-turno {
      margin-top: 15px;
      font-style: italic;
      font-size: 2em;
      text-align: center;
      z-index: 20;
    }

    /* Caja de resultados debajo de botones */
    #resultados-tiradas {
      margin-top: 20px;
      display: flex;
      gap: 15px;
      min-height: 100px;
      width: 600px;
      flex-wrap: wrap;
      justify-content: center;
      border: 2px solid #333;
      padding: 10px;
      border-radius: 10px;
      background: #fafafa;
      position: relative;
      z-index: 10;
    }

    /* Dados en resultados */
    .dice-result {
      width: 60px !important;
      height: 60px !important;
      position: relative !important;
      top: auto !important;
      left: auto !important;
      box-shadow: 0 0 10px 4px green;
      border-radius: 10px;
      margin: 0 5px;
      transition: box-shadow 0.3s ease;
    }

    /* Clases para colores de tirada */
    .color1 { box-shadow: 0 0 15px 4px #4CAF50 !important; }
    .color2 { box-shadow: 0 0 15px 4px #2196F3 !important; }
    .color3 { box-shadow: 0 0 15px 4px #FF9800 !important; }
    .color4 { box-shadow: 0 0 15px 4px #9C27B0 !important; }
    .color5 { box-shadow: 0 0 15px 4px #E91E63 !important; }
    .color6 { box-shadow: 0 0 15px 4px #00BCD4 !important; }

    /* Dados resaltados en la tirada actual (verde) */
    .resaltado-actual {
      box-shadow: 0 0 15px 4px #4CAF50 !important;
    }

    /* Dados resaltados de tiradas anteriores (azul) */
    .resaltado-previo {
      box-shadow: 0 0 15px 4px #2196F3 !important;
    }

  </style>
</head>
<body>

  <h1>Selecciona nÃºmero de jugadores</h1>
  <div class="player-select">
    <button onclick="selectPlayers(2)">2 Jugadores</button>
    <button onclick="selectPlayers(3)">3 Jugadores</button>
    <button onclick="selectPlayers(4)">4 Jugadores</button>
  </div>

  <div id="turno-actual"></div>

  <div class="dice-container" id="dados"></div>

  <div class="controls" style="display:none;">
    <button onclick="lanzarDados()">ðŸŽ² Lanzar Dados</button>
    <button onclick="plantarse()">âœ‹ Plantarse</button>
  </div>

  <div id="puntos-turno"></div>

  <!-- Caja donde se muestran dados puntuados -->
  <div id="resultados-tiradas"></div>

<script>
  let jugadores = 0;
  let puntuaciones = [];
  let turno = 0;
  let puntosTurno = 0;
  let dadosRestantes = 6;

  let tiradaNumero = 0; // para colorear tiradas
  let coloresTiradas = ["color1","color2","color3","color4","color5","color6"];

  // Guardamos dados resaltados anteriores para cambiar color
  let dadosResaltadosPrevios = [];

  function selectPlayers(count) {
    jugadores = count;
    puntuaciones = Array(count).fill(0);

    document.querySelector("h1").style.display = "none";
    document.querySelector(".player-select").style.display = "none";

    const posiciones = ["p1", "p2", "p3", "p4"];
    for (let i = 0; i < count; i++) {
      const marcador = document.createElement("div");
      marcador.className = `score ${posiciones[i]}`;
      marcador.id = `jugador${i}`;
      marcador.textContent = `Jugador ${i + 1}: 0`;
      document.body.appendChild(marcador);
    }

    document.querySelector(".controls").style.display = "flex";
    mostrarTurno();
  }

  function mostrarTurno() {
    document.getElementById("turno-actual").textContent = `Turno de Jugador ${turno + 1}`;
  }

  function mostrarDados(valores) {
    const contenedor = document.getElementById("dados");
    contenedor.innerHTML = "";

    valores.forEach((valor, idx) => {
      const dadoWrapper = document.createElement("div");
      dadoWrapper.style.position = "relative";
      dadoWrapper.style.width = "80px";
      dadoWrapper.style.height = "80px";

      // PosiciÃ³n relativa para animaciÃ³n
      // Vamos a ponerlos en fila con separaciÃ³n horizontal y posiciÃ³n absoluta para animaciÃ³n
      dadoWrapper.style.position = "absolute";
      dadoWrapper.style.left = `${idx * 90}px`;
      dadoWrapper.style.top = `0`;

      const img = document.createElement("img");
      img.src = `img/dice${valor}.png`;
      img.alt = `Dado ${valor}`;
      img.className = "dice";

      dadoWrapper.appendChild(img);
      contenedor.appendChild(dadoWrapper);
    });
  }

  function animarDado(dadoWrapper, callback) {
    const video = document.createElement("video");
    video.src = "video/lanzar.mp4";
    video.muted = true;
    video.style.position = "absolute";
    video.style.top = "0";
    video.style.left = "0";
    video.style.width = "100px";
    video.style.height = "80px";
    video.style.zIndex = "10";

    // Recortar 10px a cada lado para que el Ã¡rea visible sea 80px ancho x 80px alto
    video.style.clipPath = "inset(0 10px 0 10px)";

    dadoWrapper.appendChild(video);

    const sonido = new Audio("sounds/lanzar-dados.mp3");

    sonido.addEventListener("loadedmetadata", () => {
      if (video.readyState >= 2) {
        ajustarDuracion();
      } else {
        video.addEventListener("loadedmetadata", ajustarDuracion);
      }

      function ajustarDuracion() {
        const nuevaDuracion = sonido.duration - 2.3;
        video.playbackRate = video.duration / nuevaDuracion;
        video.play().catch(() => {});
        sonido.play().catch(() => {});
      }
    });

    video.onended = () => {
      dadoWrapper.removeChild(video);
      if (typeof callback === "function") callback();
    };
  }

  function lanzarDados() {
    if (dadosRestantes <= 0) {
      alert("No quedan dados para lanzar. Plantate o reinicia el turno.");
      return;
    }
    const cantidad = dadosRestantes;
    const dados = Array.from({ length: cantidad }, () => Math.floor(Math.random() * 6) + 1);

    const contenedor = document.getElementById("dados");
    contenedor.style.display = "block";
    mostrarDados(dados);

    let animacionesPendientes = cantidad;

    for (let i = 0; i < cantidad; i++) {
      const dadoWrapper = contenedor.children[i];
      animarDado(dadoWrapper, () => {
        animacionesPendientes--;
        if (animacionesPendientes === 0) {
          // Esperar 1 segundo antes de mover dados puntuados
          setTimeout(() => {
            procesarPuntos(dados);
            moverDadosPuntuados(dados);
          }, 1000);
        }
      });
    }
  }

  function procesarPuntos(dados) {
    const { puntos, dadosUtiles } = calcularPuntos(dados);
    if (puntos === 0) {
      alert("Â¡Sin puntos! Turno perdido.");
      puntosTurno = 0;
      pasarTurno();
    } else {
      puntosTurno += puntos;
      dadosRestantes = dados.length - dadosUtiles;
      if (dadosRestantes === 0) dadosRestantes = 6; // Si usaste todos, vuelves a 6
      document.getElementById("puntos-turno").textContent = `Puntos este turno: ${puntosTurno}`;
    }
  }

  // Calcula puntos y devuelve cuÃ¡ntos dados son Ãºtiles para puntuar
  function calcularPuntos(dados) {
    // Contar dados
    let contador = [0,0,0,0,0,0,0]; // indices 1-6
    dados.forEach(d => contador[d]++);
    let puntos = 0;
    let dadosUtiles = 0;

    // Comprobar escalera 1-6
    if (contador.slice(1).every(c => c === 1)) {
      puntos += 1500;
      dadosUtiles = 6;
      return { puntos, dadosUtiles };
    }

    // TrÃ­os, cuartetos, quintetos, sextetos
    for (let i = 1; i <= 6; i++) {
      if (contador[i] >= 3) {
        if (i === 1) {
          puntos += (contador[i] === 3) ? 1000 : 1000 * 2**(contador[i]-3);
        } else {
          puntos += i * 100 * 2**(contador[i]-3);
        }
        dadosUtiles += contador[i];
        contador[i] = 0;
      }
    }

    // 1 sueltos
    if (contador[1] > 0) {
      puntos += contador[1] * 100;
      dadosUtiles += contador[1];
    }
    // 5 sueltos
    if (contador[5] > 0) {
      puntos += contador[5] * 50;
      dadosUtiles += contador[5];
    }

    return { puntos, dadosUtiles };
  }

  // Mover dados puntuados a caja resultados con animaciÃ³n y color
  function moverDadosPuntuados(dados) {
    const resultados = document.getElementById("resultados-tiradas");

    // Color de esta tirada
    tiradaNumero = (tiradaNumero + 1) % coloresTiradas.length;
    const claseColor = coloresTiradas[tiradaNumero];

    // Cambiar dados resaltados previos a color previo
    dadosResaltadosPrevios.forEach(img => {
      img.classList.remove("resaltado-actual");
      img.classList.add("resaltado-previo");
    });
    dadosResaltadosPrevios = [];

    // Identificar dados puntuados (trÃ­os, 1 y 5, escalera)
    // Usamos la funciÃ³n calcularPuntos para saber cuÃ¡ntos dados puntÃºan
    let { dadosUtiles } = calcularPuntos(dados);

    if (dadosUtiles === 0) return; // Nada que mover

    // Extraer dados puntuados - como ejemplo vamos a mover los primeros dadosUtiles dados puntuados
    // Nota: en casos mÃ¡s complejos deberÃ­amos identificar cuÃ¡les dados exactamente puntÃºan (ej. 1,5, trÃ­os)
    // Para simplicidad, asumimos que los primeros dadosUtiles dados puntÃºan.

    const dadosPuntuados = dados.slice(0, dadosUtiles);

    // Para cada dado puntuado, crear clon, posicionarlo encima, animar hacia resultados
    const contenedorDados = document.getElementById("dados");

    dadosPuntuados.forEach((valor, idx) => {
      // Encontrar la imagen original en contenedor dados (ya que es absoluta)
      const dadoOriginal = contenedorDados.children[idx].querySelector("img");

      // Obtener posiciÃ³n en pantalla
      const rectOriginal = dadoOriginal.getBoundingClientRect();

      // Crear clon
      const clone = dadoOriginal.cloneNode();
      clone.classList.add("dice-result", "resaltado-actual", claseColor);

      // Posicionar clon en la misma posiciÃ³n absoluta (relativo a viewport)
      clone.style.position = "fixed";
      clone.style.top = `${rectOriginal.top}px`;
      clone.style.left = `${rectOriginal.left}px`;
      clone.style.margin = "0";
      clone.style.zIndex = 1000;

      document.body.appendChild(clone);

      // Objetivo: posiciÃ³n dentro del contenedor resultados
      // Calculamos posiciÃ³n del contenedor resultados + offset segÃºn cuantos hijos ya tiene
      const rectResultados = resultados.getBoundingClientRect();
      // Dejar margen 10px a la izquierda + ancho dado * nÃºmero de dados ya en resultados
      const offsetX = rectResultados.left + 10 + resultados.children.length * 65;
      const offsetY = rectResultados.top + 20;

      // Animar con transiciÃ³n CSS y transform
      // Necesitamos calcular delta X e Y
      const deltaX = offsetX - rectOriginal.left;
      const deltaY = offsetY - rectOriginal.top;

      // Forzar reflow para transiciÃ³n
      clone.style.transition = "transform 1s ease";
      requestAnimationFrame(() => {
        clone.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
      });

      // Cuando termina la transiciÃ³n, insertarlo en contenedor resultados y limpiar estilos para adaptarse al layout
      clone.addEventListener("transitionend", () => {
        clone.style.position = "relative";
        clone.style.top = "auto";
        clone.style.left = "auto";
        clone.style.transform = "none";
        clone.style.transition = "none";
        clone.style.zIndex = "auto";
        resultados.appendChild(clone);

        // Guardar para cambiar clase en siguientes tiradas
        dadosResaltadosPrevios.push(clone);
      }, { once: true });
    });
  }

  function plantarse() {
    // Guardar puntos
    puntuaciones[turno] += puntosTurno;
    document.getElementById(`jugador${turno}`).textContent = `Jugador ${turno + 1}: ${puntuaciones[turno]}`;

    // Reset puntos turno y dados
    puntosTurno = 0;
    dadosRestantes = 6;
    document.getElementById("puntos-turno").textContent = "";

    // Limpiar caja resultados
    const resultados = document.getElementById("resultados-tiradas");
    resultados.innerHTML = "";
    dadosResaltadosPrevios = [];

    // Cambiar turno
    turno = (turno + 1) % jugadores;
    mostrarTurno();

    // Limpiar dados para prÃ³xima tirada
    const contenedorDados = document.getElementById("dados");
    contenedorDados.innerHTML = "";
  }
</script>

</body>
</html>
