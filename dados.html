<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Juego de Dados</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      background: white;  /* fondo blanco como pediste */
      padding-top: 20px;
      position: relative;
      overflow-x: hidden;
    }

    h1 {
      margin-bottom: 20px;
      font-size: 3em;
      text-align: center;
    }

    .player-select,
    .controls {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
      justify-content: center;
      margin-bottom: 30px;
    }

    button {
      padding: 20px 40px;
      font-size: 2.2em;
      cursor: pointer;
      border-radius: 10px;
      border: 2px solid #333;
      background-color: white;
      transition: background 0.2s ease;
    }

    button:hover {
      background: #ddd;
    }

    .score {
      position: absolute;
      background: white;
      padding: 10px 20px;
      border: 2px solid black;
      border-radius: 10px;
      min-width: 140px;
      text-align: center;
      font-weight: bold;
      font-size: 2em;
    }

    .p1 { top: 10px; left: 10px; }
    .p2 { top: 10px; right: 10px; }
    .p3 { bottom: 10px; left: 10px; }
    .p4 { bottom: 10px; right: 10px; }

    .dice-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin: 20px 0;
      position: relative;
      height: 100px; /* espacio para dados */
    }

    .dice {
      width: 80px;
      height: 80px;
      object-fit: contain;
      border-radius: 10px;
      position: relative;
      z-index: 1;
      transition: box-shadow 0.3s ease, transform 0.7s ease;
      cursor: default;
    }

    #turno-actual {
      font-weight: bold;
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    #puntos-turno {
      margin-top: 15px;
      font-style: italic;
      font-size: 2em;
      text-align: center;
    }

    /* Nueva caja de resultados */
    #resultados-tirada {
      margin-top: 20px;
      min-height: 90px;
      width: 600px;
      border: 2px solid #333;
      border-radius: 10px;
      background: #eee;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px;
      justify-content: flex-start;
      position: relative;
    }

    /* Resaltados */
    .resaltado-actual {
      box-shadow: 0 0 12px 3px #28a745; /* verde */
      z-index: 20;
    }
    .resaltado-previo {
      box-shadow: 0 0 12px 3px #007bff; /* azul */
      z-index: 15;
    }

  </style>
</head>
<body>

  <h1>Selecciona n√∫mero de jugadores</h1>
  <div class="player-select">
    <button onclick="selectPlayers(2)">2 Jugadores</button>
    <button onclick="selectPlayers(3)">3 Jugadores</button>
    <button onclick="selectPlayers(4)">4 Jugadores</button>
  </div>

  <div id="turno-actual"></div>

  <div class="dice-container" id="dados"></div>

  <div class="controls" style="display:none;">
    <button onclick="lanzarDados()">üé≤ Lanzar Dados</button>
    <button onclick="plantarse()">‚úã Plantarse</button>
  </div>

  <div id="puntos-turno"></div>

  <!-- Caja para dados puntuados -->
  <div id="resultados-tirada" title="Dados puntuados de esta y anteriores tiradas"></div>

<script>
  let jugadores = 0;
  let puntuaciones = [];
  let turno = 0;
  let puntosTurno = 0;
  let dadosRestantes = 6;

  // Para guardar los dados puntuados previos (clones)
  let dadosPuntuadosPrevios = [];

  // Para asignar color diferente a cada tirada
  let tiradaContador = 0;

  function selectPlayers(count) {
    jugadores = count;
    puntuaciones = Array(count).fill(0);

    document.querySelector("h1").style.display = "none";
    document.querySelector(".player-select").style.display = "none";

    const posiciones = ["p1", "p2", "p3", "p4"];
    for (let i = 0; i < count; i++) {
      const marcador = document.createElement("div");
      marcador.className = `score ${posiciones[i]}`;
      marcador.id = `jugador${i}`;
      marcador.textContent = `Jugador ${i + 1}: 0`;
      document.body.appendChild(marcador);
    }

    document.querySelector(".controls").style.display = "flex";
    mostrarTurno();
  }

  function mostrarTurno() {
    document.getElementById("turno-actual").textContent = `Turno de Jugador ${turno + 1}`;
  }

  function mostrarDados(valores) {
    const contenedor = document.getElementById("dados");
    contenedor.innerHTML = "";

    valores.forEach((valor) => {
      const img = document.createElement("img");
      img.src = `img/dice${valor}.png`;
      img.alt = `Dado ${valor}`;
      img.className = "dice";
      contenedor.appendChild(img);
    });
  }

  function animarDado(dadoWrapper, callback) {
    const video = document.createElement("video");
    video.src = "video/lanzar.mp4";
    video.muted = true;
    video.style.position = "absolute";
    video.style.top = "0";
    video.style.left = "0";
    video.style.width = "100px";    // ancho aumentado para recortar
    video.style.height = "80px";    // altura dado
    video.style.zIndex = "10";
    video.style.clipPath = "inset(0 0 0 0)";

    dadoWrapper.appendChild(video);

    const sonido = new Audio("sounds/lanzar-dados.mp3");

    sonido.addEventListener("loadedmetadata", () => {
      if (video.readyState >= 2) {
        ajustarDuracion();
      } else {
        video.addEventListener("loadedmetadata", ajustarDuracion);
      }

      function ajustarDuracion() {
        const nuevaDuracion = sonido.duration - 2.3;
        video.playbackRate = video.duration / nuevaDuracion;
        video.play().catch(() => {});
        sonido.play().catch(() => {});
      }
    });

    video.onended = () => {
      dadoWrapper.removeChild(video);
      if (typeof callback === "function") callback();
    };
  }

  // Funci√≥n para detectar qu√© dados punt√∫an y cu√°les no (igual que antes)
  function calcularPuntos(dados) {
    let puntos = 0;
    let cuenta = {};
    dados.forEach(d => cuenta[d] = (cuenta[d] || 0) + 1);

    let dadosUtiles = 0;

    for (let i = 1; i <= 6; i++) {
      const cantidad = cuenta[i] || 0;
      if (cantidad >= 3) {
        puntos += i === 1 ? 300 : i * 100;
        dadosUtiles += 3;
        if (cantidad >= 4) { puntos += 1000; dadosUtiles += 1; }
        if (cantidad === 5) { puntos += 1000; dadosUtiles += 1; }
      }
    }

    puntos += (cuenta[1] || 0) < 3 ? (cuenta[1] || 0) * 100 : 0;
    puntos += (cuenta[5] || 0) < 3 ? (cuenta[5] || 0) * 50 : 0;
    dadosUtiles += (cuenta[1] || 0) < 3 ? (cuenta[1] || 0) : 0;
    dadosUtiles += (cuenta[5] || 0) < 3 ? (cuenta[5] || 0) : 0;

    return { puntos, dadosUtiles };
  }

  // Lanzar dados (simplificado)
  function lanzarDados() {
    if (dadosRestantes <= 0) {
      alert("No quedan dados para lanzar. Plantate o reinicia el turno.");
      return;
    }

    // Generar tirada random
    let tirada = [];
    for (let i = 0; i < dadosRestantes; i++) {
      tirada.push(Math.floor(Math.random() * 6) + 1);
    }

    mostrarDados(tirada);

    // Animar cada dado
    const contenedorDados = document.getElementById("dados");
    let videosTerminados = 0;
    for (let i = 0; i < contenedorDados.children.length; i++) {
      animarDado(contenedorDados.children[i], () => {
        videosTerminados++;
        if (videosTerminados === contenedorDados.children.length) {
          // tras animar, calcular puntos y mostrar resultado
          const { puntos, dadosUtiles } = calcularPuntos(tirada);
          puntosTurno += puntos;
          dadosRestantes -= dadosUtiles;

          document.getElementById("puntos-turno").textContent = `Puntos turno: ${puntosTurno}`;

          // Esperar 1 segundo y mover dados puntuados a box resultados
          setTimeout(() => {
            moverDadosPuntuados(tirada);
          }, 1000);
        }
      });
    }
  }

  // Funci√≥n que resalta y mueve dados puntuados a la caja resultados
  function moverDadosPuntuados(tirada) {
    tiradaContador++;

    const contenedorResultados = document.getElementById("resultados-tirada");

    // Crear contenedor para esta tirada
    const tiradaDiv = document.createElement("div");
    tiradaDiv.style.display = "flex";
    tiradaDiv.style.gap = "10px";
    tiradaDiv.style.marginRight = "15px";
    tiradaDiv.style.alignItems = "center";

    // Dado para cada valor en tirada, pero solo los puntuados (usamos misma l√≥gica que calcularPuntos para saber cu√°les resaltamos)
    // Vamos a repetir la l√≥gica para determinar dados puntuados

    // Primero contar repeticiones
    let cuenta = {};
    tirada.forEach(d => cuenta[d] = (cuenta[d] || 0) + 1);

    // Funci√≥n para marcar dados que punt√∫an
    // Esto es una aproximaci√≥n simple, puedes adaptar la l√≥gica seg√∫n las reglas de puntuaci√≥n

    let dadosPuntuados = [];

    // Prioridad: tr√≠os y m√°s
    for (let num = 1; num <= 6; num++) {
      if ((cuenta[num] || 0) >= 3) {
        for(let i = 0; i < 3; i++) dadosPuntuados.push(num);
        if ((cuenta[num] || 0) > 3) {
          for(let i = 3; i < cuenta[num]; i++) dadosPuntuados.push(num);
        }
      }
    }

    // Ahora a√±adir unos y cincos que no est√©n en trios
    for(let i = 0; i < (cuenta[1] || 0); i++) {
      if (!dadosPuntuados.includes(1)) dadosPuntuados.push(1);
    }
    for(let i = 0; i < (cuenta[5] || 0); i++) {
      if (!dadosPuntuados.includes(5)) dadosPuntuados.push(5);
    }

    // Para esta demo, simplificamos: dados puntuados son todos, porque la l√≥gica es compleja. 
    // Mejor usar el array tirada filtrado por dados puntuados que calculamos con el c√°lculo de puntos.

    // Vamos a simplificar y marcar todos los dados que aportan puntos: todos dados de la tirada que sumen puntos seg√∫n reglas.

    // Mejor usar la funci√≥n calcularPuntos para obtener dados que punt√∫an y su cantidad:
    let cuentaPuntuados = {};
    let { dadosUtiles } = calcularPuntos(tirada);

    // Para animaci√≥n y visualizaci√≥n, vamos a hacer que todos los dados que est√°n en la tirada sean "clonados" y enviados a la caja,
    // pero resaltaremos s√≥lo los puntuados.

    // Por simplicidad: vamos a enviar todos los dados y resaltar los puntuados, para que coincida con lo que pediste.
    // En realidad se deber√≠a distinguir los dados puntuados y solo esos moverlos, pero para mantenerlo claro:

    // Crear clones para dados puntuados (solo)
    // Para eso identificamos cu√°les dados punt√∫an, en base a la funci√≥n calcularPuntos, para demo vamos a marcar dados 1,5 y tr√≠os.

    // Para la demo, lo hacemos as√≠:
    // Dados puntuados: todos dados que sean 1, 5, o parte de tr√≠os.

    // Cuenta dados para tr√≠os:
    let dadosParaResaltar = [];

    // A√±adir tr√≠os
    for (let num = 1; num <=6; num++) {
      if ((cuenta[num] || 0) >=3) {
        for (let i=0; i < cuenta[num]; i++) dadosParaResaltar.push(num);
      }
    }

    // A√±adir unos y cincos que no est√°n en tr√≠os
    for (let i=0; i < (cuenta[1] || 0); i++) {
      if (!dadosParaResaltar.includes(1)) dadosParaResaltar.push(1);
    }
    for (let i=0; i < (cuenta[5] || 0); i++) {
      if (!dadosParaResaltar.includes(5)) dadosParaResaltar.push(5);
    }

    // Ahora filtramos para que dados puntuados sean los dados que suman puntos, eliminando duplicados
    dadosParaResaltar = [...new Set(dadosParaResaltar)];

    // Para cada dado en tirada, si est√° en dadosParaResaltar, se resalta y se mueve a resultados
    tirada.forEach(valor => {
      if (dadosParaResaltar.includes(valor)) {
        const clone = document.createElement("img");
        clone.src = `img/dice${valor}.png`;
        clone.className = "dice resaltado-actual";
        clone.style.width = "60px";
        clone.style.height = "60px";
        clone.style.borderRadius = "10px";
        clone.style.marginRight = "8px";

        tiradaDiv.appendChild(clone);
      }
    });

    // A√±adir tiradaDiv a resultados
    contenedorResultados.appendChild(tiradaDiv);

    // Cambiar clase dados previos a azul y los actuales a verde
    dadosPuntuadosPrevios.forEach(img => {
      img.classList.remove("resaltado-actual");
      img.classList.add("resaltado-previo");
    });

    // Actualizamos array dadosPuntuadosPrevios con los actuales (los hijos del tiradaDiv)
    dadosPuntuadosPrevios = Array.from(tiradaDiv.children);
  }

  // Plantarse: finaliza turno
  function plantarse() {
    puntuaciones[turno] += puntosTurno;

    // Actualizar marcador
    document.getElementById(`jugador${turno}`).textContent = `Jugador ${turno + 1}: ${puntuaciones[turno]}`;

    // Limpiar caja resultados
    document.getElementById("resultados-tirada").innerHTML = "";
    dadosPuntuadosPrevios = [];

    // Reset puntos turno y dados
    puntosTurno = 0;
    dadosRestantes = 6;

    // Cambiar turno
    turno = (turno + 1) % jugadores;
    mostrarTurno();

    document.getElementById("dados").innerHTML = "";
    document.getElementById("puntos-turno").textContent = "";
  }

</script>

</body>
</html>
